<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halal Ingredient Checker + AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            min-height: 100vh;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-5px);
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .panel-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .checker-icon {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
        }

        .chat-icon {
            background: linear-gradient(45deg, #2196F3, #03DAC6);
            color: white;
        }

        h1 {
            font-size: 22px;
            font-weight: 700;
            color: #2c3e50;
        }

        .input-section {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
            background: #fafbfc;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            transform: scale(1.02);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }

        .check-btn {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
        }

        .clear-btn {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            background: #6c757d !important;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .results-table {
            flex: 1;
            overflow-y: auto;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            font-weight: 700;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .status-cell {
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 20px;
            text-align: center;
            min-width: 100px;
        }

        .status-certified {
            background: linear-gradient(45deg, #d4edda, #c3e6cb);
            color: #155724;
        }

        .status-expiring {
            background: linear-gradient(45deg, #fff3cd, #ffeaa7);
            color: #856404;
        }

        .status-expired, .status-not-found {
            background: linear-gradient(45deg, #f8d7da, #f5c6cb);
            color: #721c24;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        /* Chat Panel Styles */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 20px;
            min-height: 300px;
            max-height: 400px;
        }

        .message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-user {
            text-align: right;
        }

        .message-ai {
            text-align: left;
        }

        .message-content {
            display: inline-block;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message-user .message-content {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .message-ai .message-content {
            background: white;
            color: #333;
            border: 1px solid #e1e8ed;
        }

        .chat-input-section {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            padding: 12px 20px;
            background: linear-gradient(45deg, #2196F3, #03DAC6);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .notification-permission {
            background: linear-gradient(45deg, #ffd700, #ffed4a);
            color: #333;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .notification-permission button {
            margin-top: 10px;
            padding: 8px 16px;
            background: #333;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 10px;
                gap: 15px;
            }

            .panel {
                padding: 20px;
            }

            h1 {
                font-size: 18px;
            }

            .button-group {
                flex-direction: column;
            }

            .chat-input-section {
                flex-direction: column;
            }

            .send-btn {
                border-radius: 12px;
            }

            .chat-input {
                border-radius: 12px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }

        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel - Ingredient Checker -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-icon checker-icon">🥗</div>
                <h1>Halal Ingredient Checker</h1>
            </div>

            <div id="notificationPermission" class="notification-permission" style="display: none;">
                Enable notifications to get alerts about expiring certificates!
                <br>
                <button onclick="requestNotificationPermission()">Enable Notifications</button>
            </div>

            <div class="input-section">
                <label for="ingredientInput">Enter ingredients (one per line):</label>
                <textarea 
                    id="ingredientInput" 
                    placeholder="Enter ingredients here, for example:&#10;Corn Starch&#10;Soy Lecithin&#10;Vanilla Extract&#10;Citric Acid&#10;Xanthan Gum"
                ></textarea>
            </div>

            <div class="button-group">
                <button class="check-btn" onclick="checkIngredients()">
                    <span id="checkBtnText">Check Ingredients</span>
                </button>
                <button class="clear-btn" onclick="clearResults()">Clear All</button>
            </div>

            <div class="stats-section" id="statsSection" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="certifiedCount">0</div>
                    <div class="stat-label">Certified</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="expiringCount">0</div>
                    <div class="stat-label">Expiring</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="issuesCount">0</div>
                    <div class="stat-label">Issues</div>
                </div>
            </div>

            <div class="results-section">
                <div class="results-table">
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th>Ingredient</th>
                                <th>Status</th>
                                <th>Expiry Date</th>
                                <th>Supplier</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                            <tr>
                                <td colspan="4" class="empty-state">
                                    Enter ingredients above and click "Check Ingredients" to see results
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Panel - AI Chatbot -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-icon chat-icon">🤖</div>
                <h1>AI Halal Assistant</h1>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message message-ai">
                    <div class="message-content">
                        Hello! I'm your Halal AI Assistant. I can help you with questions about halal ingredients, certifications, and food regulations. How can I assist you today?
                    </div>
                </div>
            </div>

            <div class="chat-input-section">
                <input 
                    type="text" 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="Ask me about halal ingredients..."
                    onkeypress="handleChatKeyPress(event)"
                >
                <button class="send-btn" onclick="sendMessage()">
                    <span id="sendBtnText">Send</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration with ngrok URLs
        const CONFIG = {
            apiEndpoints: {
                checkIngredient: 'https://c14a-27-125-240-61.ngrok-free.app/ingredient-check',
                webChat: 'https://c14a-27-125-240-61.ngrok-free.app/ingredient-check',
                responseUrl: 'https://242f-27-125-240-61.ngrok-free.app/response'
            },
            useMockData: false, // Set to true to use mock data for testing
            notificationThresholdDays: 30,
            chatId: 'session_' + Date.now() // Unique session ID
        };

        // Mock data for testing
        const MOCK_INGREDIENT_DATA = {
            'corn starch': {
                status: 'Certified',
                expiryDate: '2025-12-15',
                supplier: 'Halal Foods Sdn Bhd',
                certificateId: 'JAKIM-2024-001'
            },
            'soy lecithin': {
                status: 'Certified',
                expiryDate: '2025-07-10',
                supplier: 'Malaysian Soy Industries',
                certificateId: 'JAKIM-2024-002'
            },
            'vanilla extract': {
                status: 'Expired',
                expiryDate: '2025-05-01',
                supplier: 'Flavor Masters Sdn Bhd',
                certificateId: 'JAKIM-2023-015'
            },
            'citric acid': {
                status: 'Not Found',
                expiryDate: null,
                supplier: null,
                certificateId: null
            },
            'xanthan gum': {
                status: 'Certified',
                expiryDate: '2026-03-20',
                supplier: 'Biotech Ingredients Malaysia',
                certificateId: 'JAKIM-2024-008'
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkNotificationPermission();
            registerServiceWorker();
        });

        // Notification functions
        function checkNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                document.getElementById('notificationPermission').style.display = 'block';
            }
        }

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(function(permission) {
                    if (permission === 'granted') {
                        document.getElementById('notificationPermission').style.display = 'none';
                        showNotification('Notifications enabled!', 'You will now receive alerts about expiring certificates.');
                    }
                });
            }
        }

        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%234CAF50"/><text x="50" y="60" text-anchor="middle" fill="white" font-size="40">🥗</text></svg>',
                    badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%234CAF50"/></svg>'
                });
            }
        }

        // Service Worker registration (for push notifications)
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swCode = `
                    self.addEventListener('install', function(event) {
                        console.log('Service Worker installing');
                    });
                    
                    self.addEventListener('activate', function(event) {
                        console.log('Service Worker activated');
                    });
                    
                    self.addEventListener('notificationclick', function(event) {
                        event.notification.close();
                        event.waitUntil(
                            clients.openWindow('/')
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            }
        }

        // Ingredient checking functions
        async function checkIngredients() {
            const input = document.getElementById('ingredientInput').value.trim();
            if (!input) {
                alert('Please enter some ingredients to check.');
                return;
            }

            const ingredients = input.split('\n').filter(line => line.trim());
            const button = document.querySelector('.check-btn');
            const buttonText = document.getElementById('checkBtnText');
            
            // Show loading state
            button.disabled = true;
            button.classList.add('loading');
            buttonText.textContent = '';

            const results = [];
            const batchSize = 3;
            
            try {
                // Process ingredients in batches to avoid overwhelming the API
                for (let i = 0; i < ingredients.length; i += batchSize) {
                    const batch = ingredients.slice(i, i + batchSize);
                    const batchPromises = batch.map(ingredient => checkSingleIngredient(ingredient.trim()));
                    const batchResults = await Promise.all(batchPromises);
                    results.push(...batchResults);
                    
                    // Add small delay between batches
                    if (i + batchSize < ingredients.length) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }

                displayResults(results);
                updateStats(results);
                checkForExpiringCertificates(results);
                
            } catch (error) {
                console.error('Error checking ingredients:', error);
                alert('An error occurred while checking ingredients. Please try again.');
            } finally {
                // Reset button state
                button.disabled = false;
                button.classList.remove('loading');
                buttonText.textContent = 'Check Ingredients';
            }
        }

        async function checkSingleIngredient(ingredient) {
            if (CONFIG.useMockData) {
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 500));
                
                const mockData = MOCK_INGREDIENT_DATA[ingredient.toLowerCase()];
                if (mockData) {
                    return {
                        ingredient: ingredient,
                        ...mockData
                    };
                } else {
                    return {
                        ingredient: ingredient,
                        status: 'Not Found',
                        expiryDate: null,
                        supplier: null,
                        certificateId: null
                    };
                }
            } else {
                // Real API call using ngrok endpoints
                try {
                    // Send request to ngrok webhook
                    const checkResponse = await fetch(CONFIG.apiEndpoints.checkIngredient, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'ngrok-skip-browser-warning': 'true'
                        },
                        body: JSON.stringify({ 
                            ingredient: ingredient,
                            chatId: CONFIG.chatId + '_' + ingredient.replace(/\s+/g, '_'),
                            responseUrl: CONFIG.apiEndpoints.responseUrl
                        })
                    });
                    
                    if (!checkResponse.ok) {
                        throw new Error(`HTTP error! status: ${checkResponse.status}`);
                    }
                    
                    // Poll for response
                    const result = await pollForResponse(CONFIG.chatId + '_' + ingredient.replace(/\s+/g, '_'), ingredient);
                    return result;
                    
                } catch (error) {
                    console.error(`Error checking ingredient ${ingredient}:`, error);
                    return {
                        ingredient: ingredient,
                        status: 'Error',
                        expiryDate: null,
                        supplier: null,
                        certificateId: null
                    };
                }
            }
        }

        async function pollForResponse(chatId, ingredient, maxAttempts = 15) {
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
                try {
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds
                    
                    const response = await fetch(`${CONFIG.apiEndpoints.responseUrl}?chatId=${chatId}`, {
                        headers: {
                            'ngrok-skip-browser-warning': 'true'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 'success' && data.data) {
                            return {
                                ingredient: ingredient,
                                status: data.data.status || 'Not Found',
                                expiryDate: data.data.expiryDate || null,
                                supplier: data.data.supplier || null,
                                certificateId: data.data.certificateId || null
                            };
                        }
                    }
                } catch (error) {
                    console.error(`Polling attempt ${attempt + 1} failed:`, error);
                }
            }
            
            // If all attempts failed, return timeout result
            return {
                ingredient: ingredient,
                status: 'Timeout',
                expiryDate: null,
                supplier: null,
                certificateId: null
            };
        }

        function displayResults(results) {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            results.forEach(result => {
                const row = document.createElement('tr');
                const statusClass = getStatusClass(result.status, result.expiryDate);
                
                row.innerHTML = `
                    <td><strong>${result.ingredient}</strong></td>
                    <td><span class="status-cell ${statusClass}">${result.status}</span></td>
                    <td>${result.expiryDate ? formatDate(result.expiryDate) : '-'}</td>
                    <td>${result.supplier || '-'}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function getStatusClass(status, expiryDate) {
            if (status === 'Certified' && expiryDate) {
                const daysUntilExpiry = getDaysUntilExpiry(expiryDate);
                if (daysUntilExpiry <= CONFIG.notificationThresholdDays) {
                    return 'status-expiring';
                }
                return 'status-certified';
            } else if (status === 'Expired') {
                return 'status-expired';
            } else {
                return 'status-not-found';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-MY', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function getDaysUntilExpiry(expiryDate) {
            const today = new Date();
            const expiry = new Date(expiryDate);
            const diffTime = expiry - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function updateStats(results) {
            const stats = {
                total: results.length,
                certified: 0,
                expiring: 0,
                issues: 0
            };

            results.forEach(result => {
                if (result.status === 'Certified') {
                    if (result.expiryDate && getDaysUntilExpiry(result.expiryDate) <= CONFIG.notificationThresholdDays) {
                        stats.expiring++;
                    } else {
                        stats.certified++;
                    }
                } else {
                    stats.issues++;
                }
            });

            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('certifiedCount').textContent = stats.certified;
            document.getElementById('expiringCount').textContent = stats.expiring;
            document.getElementById('issuesCount').textContent = stats.issues;
            document.getElementById('statsSection').style.display = 'grid';
        }

        function checkForExpiringCertificates(results) {
            const expiringIngredients = results.filter(result => {
                return result.status === 'Certified' && 
                       result.expiryDate && 
                       getDaysUntilExpiry(result.expiryDate) <= CONFIG.notificationThresholdDays;
            });

            if (expiringIngredients.length > 0) {
                const ingredientNames = expiringIngredients.map(ing => ing.ingredient).join(', ');
                showNotification(
                    '⚠️ Certificates Expiring Soon!', 
                    `${expiringIngredients.length} ingredient(s) have certificates expiring within 30 days: ${ingredientNames}`
                );
            }
        }

        function clearResults() {
            document.getElementById('ingredientInput').value = '';
            document.getElementById('resultsBody').innerHTML = `
                <tr>
                    <td colspan="4" class="empty-state">
                        Enter ingredients above and click "Check Ingredients" to see results
                    </td>
                </tr>
            `;
            document.getElementById('statsSection').style.display = 'none';
        }

        // Chat functions
        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message to chat
            addMessageToChat(message, 'user');
            input.value = '';

            // Show loading state
            const sendBtn = document.querySelector('.send-btn');
            const sendBtnText = document.getElementById('sendBtnText');
            sendBtn.disabled = true;
            sendBtn.classList.add('loading');
            sendBtnText.textContent = '';

            try {
                let response;
                
                if (CONFIG.useMockData) {
                    // Mock AI responses
                    response = await getMockChatResponse(message);
                } else {
                    // Real API call using ngrok endpoints
                    const chatId = CONFIG.chatId + '_chat_' + Date.now();
                    
                    const chatResponse = await fetch(CONFIG.apiEndpoints.webChat, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'ngrok-skip-browser-warning': 'true'
                        },
                        body: JSON.stringify({ 
                            ingredient: message, // Using message as ingredient for chat
                            chatId: chatId,
                            responseUrl: CONFIG.apiEndpoints.responseUrl
                        })
                    });
                    
                    if (!chatResponse.ok) {
                        throw new Error(`HTTP error! status: ${chatResponse.status}`);
                    }
                    
                    // Poll for chat response
                    response = await pollForChatResponse(chatId);
                }

                // Add AI response to chat
                addMessageToChat(response, 'ai');
                
            } catch (error) {
                console.error('Error sending message:', error);
                addMessageToChat('Sorry, I\'m having trouble connecting right now. Please try again later.', 'ai');
            } finally {
                // Reset button state
                sendBtn.disabled = false;
                sendBtn.classList.remove('loading');
                sendBtnText.textContent = 'Send';
            }
        }

        async function pollForChatResponse(chatId, maxAttempts = 10) {
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
                try {
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds
                    
                    const response = await fetch(`${CONFIG.apiEndpoints.responseUrl}?chatId=${chatId}`, {
                        headers: {
                            'ngrok-skip-browser-warning': 'true'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 'success' && data.message) {
                            return data.message;
                        }
                    }
                } catch (error) {
                    console.error(`Chat polling attempt ${attempt + 1} failed:`, error);
                }
            }
            
            // If all attempts failed, return timeout message
            return 'Sorry, I\'m taking too long to respond. Please try asking again.';
        }

        async function getMockChatResponse(message) {
            // Simulate AI thinking time
            await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
            
            const responses = {
                'hello': 'Hello! I\'m here to help you with halal ingredient questions. What would you like to know?',
                'help': 'I can help you understand halal certifications, ingredient origins, and food regulations. Try asking about specific ingredients or certification processes.',
                'what is halal': 'Halal refers to food that is permissible according to Islamic law. For ingredients to be halal, they must not contain pork, alcohol, or other forbidden substances, and must be processed according to Islamic guidelines.',
                'gelatin': 'Gelatin can be halal or haram depending on its source. Halal gelatin is typically derived from halal-slaughtered cattle or fish, while pork-derived gelatin is not halal. Always check the certification.',
                'emulsifier': 'Emulsifiers like lecithin can be halal if derived from plant sources (like soy) or halal animal sources. E471, E472, and similar codes should be verified with proper halal certification.',
                'vanilla': 'Pure vanilla extract often contains alcohol, which may not be halal. Look for alcohol-free vanilla or vanilla certified as halal. Artificial vanilla is usually halal.',
                'certification': 'Halal certification ensures ingredients meet Islamic dietary requirements. Look for certificates from recognized bodies like JAKIM, MUIS, or other authorized halal certifying organizations.'
            };
            
            const lowerMessage = message.toLowerCase();
            
            // Check for keyword matches
            for (const [keyword, response] of Object.entries(responses)) {
                if (lowerMessage.includes(keyword)) {
                    return response;
                }
            }
            
            // Default response for unmatched queries
            return 'That\'s an interesting question about halal ingredients. While I don\'t have specific information about that, I recommend checking with certified halal authorities or looking for products with proper halal certification. Is there anything else about halal ingredients I can help you with?';
        }

        function addMessageToChat(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${sender}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = message;
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Initialize chat with welcome message if not already present
        function initializeChat() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages.children.length === 0) {
                addMessageToChat('Hello! I\'m your Halal AI Assistant. I can help you with questions about halal ingredients, certifications, and food regulations. How can I assist you today?', 'ai');
            }
        }

        // Auto-save functionality for ingredient input
        function autoSaveInput() {
            const input = document.getElementById('ingredientInput');
            const savedInput = localStorage.getItem('halalChecker_savedInput');
            
            if (savedInput) {
                input.value = savedInput;
            }
            
            input.addEventListener('input', function() {
                localStorage.setItem('halalChecker_savedInput', this.value);
            });
        }

        // Export results functionality
        function exportResults() {
            const table = document.getElementById('resultsTable');
            const rows = table.querySelectorAll('tbody tr');
            
            if (rows.length === 1 && rows[0].textContent.includes('Enter ingredients')) {
                alert('No results to export. Please check some ingredients first.');
                return;
            }
            
            let csvContent = 'Ingredient,Status,Expiry Date,Supplier\n';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 4) {
                    const rowData = Array.from(cells).map(cell => {
                        const text = cell.textContent.trim();
                        return text.includes(',') ? `"${text}"` : text;
                    });
                    csvContent += rowData.join(',') + '\n';
                }
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `halal_ingredients_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Ctrl/Cmd + Enter to check ingredients
            if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                event.preventDefault();
                checkIngredients();
            }
            
            // Ctrl/Cmd + L to clear results
            if ((event.ctrlKey || event.metaKey) && event.key === 'l') {
                event.preventDefault();
                clearResults();
            }
            
            // Ctrl/Cmd + E to export results
            if ((event.ctrlKey || event.metaKey) && event.key === 'e') {
                event.preventDefault();
                exportResults();
            }
        });

        // Enhanced initialization
        document.addEventListener('DOMContentLoaded', function() {
            checkNotificationPermission();
            registerServiceWorker();
            initializeChat();
            autoSaveInput();
            
            // Add export button to stats section
            const statsSection = document.getElementById('statsSection');
            if (statsSection) {
                const exportButton = document.createElement('button');
                exportButton.textContent = 'Export CSV';
                exportButton.className = 'export-btn';
                exportButton.style.cssText = `
                    grid-column: 1 / -1;
                    margin-top: 10px;
                    padding: 8px 16px;
                    background: linear-gradient(45deg, #6c757d, #495057);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                    transition: all 0.3s ease;
                `;
                exportButton.onclick = exportResults;
                statsSection.appendChild(exportButton);
            }
            
            // Add keyboard shortcut hints
            const shortcuts = document.createElement('div');
            shortcuts.innerHTML = `
                <div style="
                    position: fixed;
                    bottom: 10px;
                    right: 10px;
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 10px;
                    border-radius: 8px;
                    font-size: 12px;
                    opacity: 0.7;
                    z-index: 1000;
                ">
                    <div><kbd>Ctrl+Enter</kbd> Check ingredients</div>
                    <div><kbd>Ctrl+L</kbd> Clear results</div>
                    <div><kbd>Ctrl+E</kbd> Export CSV</div>
                </div>
            `;
            document.body.appendChild(shortcuts);
        });

        // Error handling for network issues
        window.addEventListener('online', function() {
            addMessageToChat('Connection restored! You can now use the ingredient checker and chat features.', 'ai');
        });

        window.addEventListener('offline', function() {
            addMessageToChat('You\'re currently offline. Some features may not work properly.', 'ai');
        });

        // Performance monitoring
        function logPerformance(action, startTime) {
            const endTime = performance.now();
            const duration = endTime - startTime;
            console.log(`${action} completed in ${duration.toFixed(2)} milliseconds`);
        }
    </script>
</body>
</html>