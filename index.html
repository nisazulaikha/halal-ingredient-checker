<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halal Ingredient Checker + AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            min-height: 100vh;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-5px);
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .panel-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .checker-icon {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
        }

        .chat-icon {
            background: linear-gradient(45deg, #2196F3, #03DAC6);
            color: white;
        }

        h1 {
            font-size: 22px;
            font-weight: 700;
            color: #2c3e50;
        }

        .input-section {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
            background: #fafbfc;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            transform: scale(1.02);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            position: relative;
            overflow: hidden;
            min-width: 120px;
        }

        .check-btn {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
        }

        .clear-btn {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
        }

        .export-btn {
            background: linear-gradient(45deg, #17a2b8, #20c997);
            color: white;
        }

        .debug-btn {
            background: #6c757d;
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            background: #6c757d !important;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .results-table {
            flex: 1;
            overflow-y: auto;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            font-weight: 700;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .status-cell {
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 20px;
            text-align: center;
            min-width: 100px;
        }

        .status-certified {
            background: linear-gradient(45deg, #d4edda, #c3e6cb);
            color: #155724;
        }

        .status-expiring {
            background: linear-gradient(45deg, #fff3cd, #ffeaa7);
            color: #856404;
        }

        .status-expired, .status-not-found {
            background: linear-gradient(45deg, #f8d7da, #f5c6cb);
            color: #721c24;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        /* Chat Panel Styles */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 20px;
            min-height: 300px;
            max-height: 400px;
        }

        .message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-user {
            text-align: right;
        }

        .message-ai {
            text-align: left;
        }

        .message-content {
            display: inline-block;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message-user .message-content {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .message-ai .message-content {
            background: white;
            color: #333;
            border: 1px solid #e1e8ed;
        }

        .chat-input-section {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            padding: 12px 20px;
            background: linear-gradient(45deg, #2196F3, #03DAC6);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .config-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }

        .config-section h3 {
            margin-bottom: 10px;
            color: #1976d2;
            font-size: 16px;
        }

        .config-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .config-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-testing {
            background: #fff3cd;
            color: #856404;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 10px;
                gap: 15px;
            }

            .panel {
                padding: 20px;
            }

            h1 {
                font-size: 18px;
            }

            .button-group {
                flex-direction: column;
            }

            .chat-input-section {
                flex-direction: column;
            }

            .send-btn {
                border-radius: 12px;
            }

            .chat-input {
                border-radius: 12px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }

        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .alert {
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 12px;
        }

        .debug-panel h4 {
            margin-bottom: 10px;
            color: #495057;
        }

        .debug-log {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .typing-indicator .dots {
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0;
            }
            30% {
                opacity: 1;
            }
        }

        .test-connection-btn {
            background: linear-gradient(45deg, #6f42c1, #e83e8c);
            color: white;
            font-size: 12px;
            padding: 6px 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel - Ingredient Checker -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-icon checker-icon">ü•ó</div>
                <h1>Halal Ingredient Checker</h1>
            </div>

            <!-- Configuration Section -->
            <div class="config-section">
                <h3>‚öôÔ∏è API Configuration</h3>
                <div class="config-toggle">
                    <input type="checkbox" id="useMockData">
                    <label for="useMockData">Use Mock Data (for testing)</label>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <label for="apiUrl" style="font-size: 12px;">Ingredient Check API:</label>
                    <input type="text" id="apiUrl" class="config-input" 
                        placeholder="https://your-ngrok-url.ngrok-free.app/webhook/ingredient-check" 
                        value="https://fb62-27-125-241-114.ngrok-free.app/webhook/ingredient-check">
                </div>
                
                <div style="margin-bottom: 10px;">
                    <label for="responseUrl" style="font-size: 12px;">Response Webhook URL:</label>
                    <input type="text" id="responseUrl" class="config-input" 
                        placeholder="https://your-ngrok-url.ngrok-free.app/webhook/[id]/response" 
                        value="https://fb62-27-125-241-114.ngrok-free.app/webhook/f3f51804-fafc-4103-bff9-4dc5ab97ff2f/response">
                </div>
                
                <div style="margin-bottom: 10px;">
                    <label for="chatResponseUrl" style="font-size: 12px;">Chat Response URL:</label>
                    <input type="text" id="chatResponseUrl" class="config-input" 
                        placeholder="https://your-ngrok-url.ngrok-free.app/webhook/[id]/response/chat" 
                        value="https://fb62-27-125-241-114.ngrok-free.app/webhook/bb06b7cf-8a49-4f1e-ba44-ca85271eeaf6/response/chat">
                </div>
                
                <button class="test-connection-btn" onclick="testConnection()">
                    üîó Test Connection
                </button>
                
                <div id="connectionStatus" class="connection-status status-disconnected">
                    <span class="status-indicator"></span>
                    <span>Not Connected - Click Test Connection</span>
                </div>
            </div>

            <!-- Debug Panel -->
            <div class="debug-panel" id="debugPanel" style="display: none;">
                <h4>üîç Debug Information</h4>
                <div class="debug-log" id="debugLog"></div>
                <button onclick="clearDebugLog()" style="margin-top: 10px; padding: 5px 10px; font-size: 11px;">Clear Log</button>
            </div>

            <div class="input-section">
                <label for="ingredientInput">Enter ingredients (one per line):</label>
                <textarea 
                    id="ingredientInput" 
                    placeholder="Enter ingredients here, for example:&#10;Corn Starch&#10;Soy Lecithin&#10;Vanilla Extract&#10;Citric Acid&#10;Xanthan Gum&#10;Gelatin&#10;Lecithin&#10;Mono- and Diglycerides"
                ></textarea>
            </div>

            <div class="button-group">
                <button class="check-btn" onclick="checkIngredients()">
                    <span id="checkBtnText">‚úÖ Check Ingredients</span>
                </button>
                <button class="clear-btn" onclick="clearResults()">üóëÔ∏è Clear All</button>
                <button class="export-btn" onclick="exportResults()">üì• Export</button>
                <button class="debug-btn" onclick="toggleDebugPanel()">üîß Debug</button>
            </div>

            <div class="stats-section" id="statsSection" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="certifiedCount">0</div>
                    <div class="stat-label">Certified</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="expiringCount">0</div>
                    <div class="stat-label">Expiring</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="issuesCount">0</div>
                    <div class="stat-label">Issues</div>
                </div>
            </div>

            <div class="results-section">
                <div class="results-table">
                    <table id="resultsTable" class="table">
                        <thead>
                            <tr>
                                <th>Ingredient</th>
                                <th>Status</th>
                                <th>Expiry Date</th>
                                <th>Supplier</th>
                                <th>Certificate ID</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                            <tr>
                                <td colspan="5" class="empty-state">
                                    Enter ingredients above and click "Check Ingredients" to see results
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Panel - AI Chatbot -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-icon chat-icon">ü§ñ</div>
                <h1>AI Halal Assistant</h1>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message message-ai">
                    <div class="message-content">
                        üåô Assalamu Alaikum! I'm your Halal AI Assistant. I can help you with questions about halal ingredients, certifications, and Islamic food regulations. Ask me anything about halal compliance!
                    </div>
                </div>
            </div>

            <div class="chat-input-section">
                <input 
                    type="text" 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="Ask about halal ingredients, certifications..."
                    onkeypress="handleChatKeyPress(event)"
                >
                <button class="send-btn" onclick="sendMessage()">
                    <span id="sendBtnText">Send</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Configuration
        const CONFIG = {
            apiEndpoints: {
                primary: 'https://fb62-27-125-241-114.ngrok-free.app/webhook/ingredient-check',
                responseUrl: 'https://fb62-27-125-241-114.ngrok-free.app/webhook/f3f51804-fafc-4103-bff9-4dc5ab97ff2f/response',
                chatResponseUrl: 'https://fb62-27-125-241-114.ngrok-free.app/webhook/bb06b7cf-8a49-4f1e-ba44-ca85271eeaf6/response/chat'
            },
            useMockData: false, // Default to real API
            notificationThresholdDays: 30,
            chatId: 'session_' + Date.now(),
            polling: {
                maxAttempts: 20,
                initialDelay: 2000,
                backoffMultiplier: 1.1,
                maxDelay: 8000
            },
            connectionTested: false
        };

        // Enhanced Mock Data
        const MOCK_INGREDIENT_DATA = {
            'corn starch': {
                status: 'Certified',
                expiryDate: '2025-12-15',
                supplier: 'Halal Foods Sdn Bhd',
                certificateId: 'JAKIM-2024-001'
            },
            'soy lecithin': {
                status: 'Certified',
                expiryDate: '2025-07-10',
                supplier: 'Malaysian Soy Industries',
                certificateId: 'JAKIM-2024-002'
            },
            'vanilla extract': {
                status: 'Certified',
                expiryDate: '2025-08-15',
                supplier: 'Flavor Masters Sdn Bhd',
                certificateId: 'JAKIM-2024-015'
            },
            'citric acid': {
                status: 'Certified',
                expiryDate: '2025-11-30',
                supplier: 'Chemical Solutions Malaysia',
                certificateId: 'JAKIM-2024-020'
            },
            'xanthan gum': {
                status: 'Certified',
                expiryDate: '2026-03-20',
                supplier: 'Biotech Ingredients Malaysia',
                certificateId: 'JAKIM-2024-008'
            },
            'lecithin': {
                status: 'Expiring',
                expiryDate: '2025-07-01',
                supplier: 'Natural Ingredients Co.',
                certificateId: 'JAKIM-2024-012'
            },
            'gelatin': {
                status: 'Not Found',
                expiryDate: 'N/A',
                supplier: 'Unknown',
                certificateId: 'N/A'
            },
            'mono- and diglycerides': {
                status: 'Certified',
                expiryDate: '2025-10-15',
                supplier: 'Halal Emulsifiers Sdn Bhd',
                certificateId: 'JAKIM-2024-025'
            }
        };

        // Debug logging
        let debugLog = [];
        
        function log(message, level = 'info') {
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
            debugLog.push(logEntry);
            console.log(logEntry);
            
            if (debugLog.length > 100) {
                debugLog = debugLog.slice(-100);
            }
            
            updateDebugPanel();
        }

        function updateDebugPanel() {
            const debugLogElement = document.getElementById('debugLog');
            if (debugLogElement) {
                debugLogElement.textContent = debugLog.join('\n');
                debugLogElement.scrollTop = debugLogElement.scrollHeight;
            }
        }

        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function clearDebugLog() {
            debugLog = [];
            updateDebugPanel();
        }

        // Connection testing
        async function testConnection() {
            const statusEl = document.getElementById('connectionStatus');
            const testBtn = document.querySelector('.test-connection-btn');
            
            statusEl.className = 'connection-status status-testing';
            statusEl.innerHTML = '<span class="status-indicator"></span><span>Testing connection...</span>';
            testBtn.disabled = true;
            testBtn.textContent = 'üîÑ Testing...';
            
            log('Testing connection to API endpoints...');
            
            try {
                updateConfigFromUI();
                
                // Test basic connectivity
                const response = await fetch(CONFIG.apiEndpoints.primary, {
                    method: 'HEAD',
                    mode: 'cors',
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                
                if (response.ok || response.status === 405) { // 405 is OK for HEAD requests
                    CONFIG.connectionTested = true;
                    statusEl.className = 'connection-status status-connected';
                    statusEl.innerHTML = '<span class="status-indicator"></span><span>‚úÖ Connected Successfully</span>';
                    log('Connection test successful');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                log(`Connection test failed: ${error.message}`, 'error');
                statusEl.className = 'connection-status status-disconnected';
                statusEl.innerHTML = '<span class="status-indicator"></span><span>‚ùå Connection Failed</span>';
                
                showAlert('Connection test failed. Check your ngrok URL and n8n workflow.', 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'üîó Test Connection';
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            log('Initializing Enhanced Halal Ingredient Checker...');
            setupConfigurationHandlers();
            initializeChat();
            autoSaveInput();
            
            updateConfigFromUI();
            log('App initialized successfully');
        }

        function setupConfigurationHandlers() {
            const mockDataCheckbox = document.getElementById('useMockData');
            const apiUrlInput = document.getElementById('apiUrl');
            const responseUrlInput = document.getElementById('responseUrl');
            const chatResponseUrlInput = document.getElementById('chatResponseUrl');
            
            mockDataCheckbox.addEventListener('change', function() {
                CONFIG.useMockData = this.checked;
                log(`Mock data mode: ${this.checked ? 'enabled' : 'disabled'}`);
                updateConnectionStatus();
            });
            
            [apiUrlInput, responseUrlInput, chatResponseUrlInput].forEach(input => {
                input.addEventListener('input', function() {
                    CONFIG.connectionTested = false;
                    updateConnectionStatus();
                });
            });
        }

        function updateConfigFromUI() {
            const mockDataCheckbox = document.getElementById('useMockData');
            const apiUrlInput = document.getElementById('apiUrl');
            const responseUrlInput = document.getElementById('responseUrl');
            const chatResponseUrlInput = document.getElementById('chatResponseUrl');
            
            CONFIG.useMockData = mockDataCheckbox.checked;
            CONFIG.apiEndpoints.primary = apiUrlInput.value.trim();
            CONFIG.apiEndpoints.responseUrl = responseUrlInput.value.trim();
            CONFIG.apiEndpoints.chatResponseUrl = chatResponseUrlInput.value.trim();
        }

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            
            if (CONFIG.useMockData) {
                statusEl.className = 'connection-status status-connected';
                statusEl.innerHTML = '<span class="status-indicator"></span><span>üß™ Mock Mode Active</span>';
            } else if (!CONFIG.connectionTested) {
                statusEl.className = 'connection-status status-disconnected';
                statusEl.innerHTML = '<span class="status-indicator"></span><span>‚ö†Ô∏è Connection Not Tested</span>';
            }
        }

        // Enhanced API calls
        async function makeApiCall(url, options = {}) {
            log(`Making API call to: ${url}`);
            
            try {
                const response = await fetch(url, {
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'ngrok-skip-browser-warning': 'true',
                        ...options.headers
                    },
                    ...options
                });

                log(`API response: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response;
                
            } catch (error) {
                log(`API call failed: ${error.message}`, 'error');
                throw error;
            }
        }

        // Auto-save input
        function autoSaveInput() {
            const input = document.getElementById('ingredientInput');
            const savedInput = localStorage.getItem('ingredientInput');
            if (savedInput) {
                input.value = savedInput;
            }
            
            input.addEventListener('input', function() {
                localStorage.setItem('ingredientInput', this.value);
            });
        }

        // Enhanced ingredient checking
        async function checkIngredients() {
            updateConfigFromUI();
            
            const input = document.getElementById('ingredientInput');
            const ingredients = input.value.trim().split('\n').filter(line => line.trim());
            
            if (ingredients.length === 0) {
                showAlert('Please enter at least one ingredient.', 'warning');
                return;
            }

            log(`Checking ${ingredients.length} ingredients...`);
            setLoadingState(true);
            
            try {
                if (CONFIG.useMockData) {
                    await processMockData(ingredients);
                } else {
                    await processRealData(ingredients);
                }
            } catch (error) {
                log(`Ingredient check failed: ${error.message}`, 'error');
                showAlert(`Error checking ingredients: ${error.message}`, 'error');
            } finally {
                setLoadingState(false);
            }
        }

        async function processMockData(ingredients) {
            log('Using mock data for ingredient checking');
            
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const results = ingredients.map(ingredient => {
                const cleanIngredient = ingredient.trim().toLowerCase();
                const mockData = MOCK_INGREDIENT_DATA[cleanIngredient] || {
                    status: 'Not Found',
                    expiryDate: 'N/A',
                    supplier: 'Unknown',
                    certificateId: 'N/A'
                };
                
                return {
                    ingredient: ingredient.trim(),
                    ...mockData
                };
            });
            
            displayResults(results);
            log('Mock data processing completed');
        }

        async function processRealData(ingredients) {
            log('Using real API for ingredient checking');
            
            const payload = {
                ingredients: ingredients.map(i => i.trim()),
                chatId: CONFIG.chatId,
                timestamp: new Date().toISOString()
            };
            
            // Send request to n8n
            await makeApiCall(CONFIG.apiEndpoints.primary, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            
            log('Request sent to n8n, waiting for response...');
            showAlert('Request sent! Waiting for results...', 'success');
            
            // Start polling for results
            await pollForResults();
        }

        async function pollForResults() {
            let attempt = 0;
            let delay = CONFIG.polling.initialDelay;
            
            while (attempt < CONFIG.polling.maxAttempts) {
                attempt++;
                log(`Polling attempt ${attempt}/${CONFIG.polling.maxAttempts}`);
                
                try {
                    const response = await makeApiCall(CONFIG.apiEndpoints.responseUrl);
                    const data = await response.json();
                    
                    if (data && data.results) {
                        log('Results received from API');
                        displayResults(data.results);
                        return;
                    }
                    
                    log(`No results yet, waiting ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay = Math.min(delay * CONFIG.polling.backoffMultiplier, CONFIG.polling.maxDelay);
                    
                } catch (error) {
                    log(`Polling error (attempt ${attempt}): ${error.message}`, 'warn');
                    
                    if (attempt === CONFIG.polling.maxAttempts) {
                        throw new Error('Timeout waiting for results. Please try again.');
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay = Math.min(delay * CONFIG.polling.backoffMultiplier, CONFIG.polling.maxDelay);
                }
            }
            
            throw new Error('Maximum polling attempts reached');
        }

        function displayResults(results) {
            const tbody = document.getElementById('resultsBody');
            const statsSection = document.getElementById('statsSection');
            
            tbody.innerHTML = '';
            
            if (!results || results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No results to display</td></tr>';
                statsSection.style.display = 'none';
                return;
            }

            let stats = { total: 0, certified: 0, expiring: 0, issues: 0 };
            
            results.forEach(result => {
                const row = document.createElement('tr');
                const statusClass = getStatusClass(result.status);
                
                row.innerHTML = `
                    <td>${escapeHtml(result.ingredient)}</td>
                    <td><span class="status-cell ${statusClass}">${escapeHtml(result.status)}</span></td>
                    <td>${escapeHtml(result.expiryDate || 'N/A')}</td>
                    <td>${escapeHtml(result.supplier || 'Unknown')}</td>
                    <td>${escapeHtml(result.certificateId || 'N/A')}</td>
                `;
                
                tbody.appendChild(row);
                
                // Update stats
                stats.total++;
                if (result.status === 'Certified') stats.certified++;
                else if (result.status === 'Expiring') stats.expiring++;
                else stats.issues++;
            });
            
            updateStats(stats);
            statsSection.style.display = 'grid';
            
            log(`Displayed ${results.length} ingredient results`);
        }

        function getStatusClass(status) {
            const statusMap = {
                'Certified': 'status-certified',
                'Expiring': 'status-expiring',
                'Expired': 'status-expired',
                'Not Found': 'status-not-found'
            };
            return statusMap[status] || 'status-not-found';
        }

        function updateStats(stats) {
            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('certifiedCount').textContent = stats.certified;
            document.getElementById('expiringCount').textContent = stats.expiring;
            document.getElementById('issuesCount').textContent = stats.issues;
        }

        function setLoadingState(loading) {
            const checkBtn = document.querySelector('.check-btn');
            const checkBtnText = document.getElementById('checkBtnText');
            
            if (loading) {
                checkBtn.disabled = true;
                checkBtn.classList.add('loading');
                checkBtnText.textContent = 'Checking...';
            } else {
                checkBtn.disabled = false;
                checkBtn.classList.remove('loading');
                checkBtnText.textContent = '‚úÖ Check Ingredients';
            }
        }

        function clearResults() {
            document.getElementById('ingredientInput').value = '';
            document.getElementById('resultsBody').innerHTML = 
                '<tr><td colspan="5" class="empty-state">Enter ingredients above and click "Check Ingredients" to see results</td></tr>';
            document.getElementById('statsSection').style.display = 'none';
            localStorage.removeItem('ingredientInput');
            log('Results cleared');
        }

        function exportResults() {
            const rows = document.querySelectorAll('#resultsTable tbody tr');
            if (rows.length === 1 && rows[0].querySelector('.empty-state')) {
                showAlert('No results to export.', 'warning');
                return;
            }
            
            let csv = 'Ingredient,Status,Expiry Date,Supplier,Certificate ID\n';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 5) {
                    const values = Array.from(cells).map(cell => {
                        const statusSpan = cell.querySelector('.status-cell');
                        return statusSpan ? statusSpan.textContent : cell.textContent;
                    });
                    csv += values.map(v => `"${v.replace(/"/g, '""')}"`).join(',') + '\n';
                }
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `halal_ingredients_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('Results exported to CSV');
        }

        // Chat functionality
        function initializeChat() {
            log('Initializing chat functionality');
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            updateConfigFromUI();
            
            // Add user message to chat
            addMessageToChat(message, 'user');
            input.value = '';
            
            // Show typing indicator
            addTypingIndicator();
            setChatLoadingState(true);
            
            log(`Sending chat message: ${message}`);
            
            try {
                if (CONFIG.useMockData) {
                    await processMockChatResponse(message);
                } else {
                    await processRealChatResponse(message);
                }
            } catch (error) {
                log(`Chat error: ${error.message}`, 'error');
                removeTypingIndicator();
                addMessageToChat('Sorry, I encountered an error. Please try again.', 'ai');
            } finally {
                setChatLoadingState(false);
            }
        }

        async function processMockChatResponse(message) {
            // Simulate processing delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const responses = [
                "That's a great question about halal ingredients! Based on Islamic dietary laws, ingredients must be free from pork, alcohol, and other prohibited substances.",
                "For halal certification, it's important to verify the source and processing methods of ingredients. Would you like me to check specific ingredients?",
                "Gelatin is often a concern in halal food - it can be derived from pork or beef. Beef gelatin from halal-slaughtered animals is permissible.",
                "Emulsifiers like mono- and diglycerides can be plant or animal-derived. The halal status depends on the source.",
                "I can help you understand halal ingredient requirements. What specific ingredients are you concerned about?"
            ];
            
            const response = responses[Math.floor(Math.random() * responses.length)];
            
            removeTypingIndicator();
            addMessageToChat(response, 'ai');
            log('Mock chat response sent');
        }

        async function processRealChatResponse(message) {
            const payload = {
                message: message,
                chatId: CONFIG.chatId,
                timestamp: new Date().toISOString()
            };
            
            // Send to n8n chat endpoint
            await makeApiCall(CONFIG.apiEndpoints.primary.replace('/ingredient-check', '/chat'), {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            
            log('Chat message sent to n8n, waiting for response...');
            
            // Poll for chat response
            await pollForChatResponse();
        }

        async function pollForChatResponse() {
            let attempt = 0;
            let delay = CONFIG.polling.initialDelay;
            
            while (attempt < CONFIG.polling.maxAttempts) {
                attempt++;
                log(`Chat polling attempt ${attempt}/${CONFIG.polling.maxAttempts}`);
                
                try {
                    const response = await makeApiCall(CONFIG.apiEndpoints.chatResponseUrl);
                    const data = await response.json();
                    
                    if (data && data.response) {
                        log('Chat response received from API');
                        removeTypingIndicator();
                        addMessageToChat(data.response, 'ai');
                        return;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay = Math.min(delay * CONFIG.polling.backoffMultiplier, CONFIG.polling.maxDelay);
                    
                } catch (error) {
                    log(`Chat polling error (attempt ${attempt}): ${error.message}`, 'warn');
                    
                    if (attempt === CONFIG.polling.maxAttempts) {
                        throw new Error('Timeout waiting for chat response');
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            
            throw new Error('Maximum chat polling attempts reached');
        }

        function addMessageToChat(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${sender}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = message;
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message message-ai typing-indicator';
            typingDiv.id = 'typingIndicator';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = '<span class="dots">‚óè‚óè‚óè</span> Thinking...';
            
            typingDiv.appendChild(contentDiv);
            chatMessages.appendChild(typingDiv);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function setChatLoadingState(loading) {
            const sendBtn = document.querySelector('.send-btn');
            const sendBtnText = document.getElementById('sendBtnText');
            const chatInput = document.getElementById('chatInput');
            
            if (loading) {
                sendBtn.disabled = true;
                chatInput.disabled = true;
                sendBtnText.textContent = '...';
            } else {
                sendBtn.disabled = false;
                chatInput.disabled = false;
                sendBtnText.textContent = 'Send';
            }
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showAlert(message, type) {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            const container = document.querySelector('.panel');
            container.insertBefore(alert, container.firstChild.nextSibling);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        // Error handling
        window.addEventListener('error', function(event) {
            log(`JavaScript error: ${event.error.message}`, 'error');
        });

        window.addEventListener('unhandledrejection', function(event) {
            log(`Unhandled promise rejection: ${event.reason}`, 'error');
        });
    </script>
    <script src="main.js"></script>
</body>
</html>
