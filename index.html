<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halal Ingredient Checker + AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            min-height: 100vh;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-5px);
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .panel-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .checker-icon {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
        }

        .chat-icon {
            background: linear-gradient(45deg, #2196F3, #03DAC6);
            color: white;
        }

        h1 {
            font-size: 22px;
            font-weight: 700;
            color: #2c3e50;
        }

        .input-section {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
            background: #fafbfc;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            transform: scale(1.02);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }

        .check-btn {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
        }

        .clear-btn {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            background: #6c757d !important;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .results-table {
            flex: 1;
            overflow-y: auto;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            font-weight: 700;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .status-cell {
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 20px;
            text-align: center;
            min-width: 100px;
        }

        .status-certified {
            background: linear-gradient(45deg, #d4edda, #c3e6cb);
            color: #155724;
        }

        .status-expiring {
            background: linear-gradient(45deg, #fff3cd, #ffeaa7);
            color: #856404;
        }

        .status-expired, .status-not-found {
            background: linear-gradient(45deg, #f8d7da, #f5c6cb);
            color: #721c24;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        /* Chat Panel Styles */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 20px;
            min-height: 300px;
            max-height: 400px;
        }

        .message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-user {
            text-align: right;
        }

        .message-ai {
            text-align: left;
        }

        .message-content {
            display: inline-block;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message-user .message-content {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .message-ai .message-content {
            background: white;
            color: #333;
            border: 1px solid #e1e8ed;
        }

        .chat-input-section {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            padding: 12px 20px;
            background: linear-gradient(45deg, #2196F3, #03DAC6);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .config-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }

        .config-section h3 {
            margin-bottom: 10px;
            color: #1976d2;
        }

        .config-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .config-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 10px;
                gap: 15px;
            }

            .panel {
                padding: 20px;
            }

            h1 {
                font-size: 18px;
            }

            .button-group {
                flex-direction: column;
            }

            .chat-input-section {
                flex-direction: column;
            }

            .send-btn {
                border-radius: 12px;
            }

            .chat-input {
                border-radius: 12px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }

        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .alert {
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .typing-indicator .dots {
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0;
            }
            30% {
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel - Ingredient Checker -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-icon checker-icon">ü•ó</div>
                <h1>Halal Ingredient Checker</h1>
            </div>

            <!-- Configuration Section -->
            <div class="config-section">
                <h3>API Configuration</h3>
                <div class="config-toggle">
                    <input type="checkbox" id="useMockData" checked>
                    <label for="useMockData">Use Mock Data (disable for real API)</label>
                </div>
                <div style="margin-bottom: 10px;">
                    <label for="apiUrl" style="font-size: 12px;">Webhook URL:</label>
                    <input type="text" id="apiUrl" class="config-input" 
                           placeholder="https://your-ngrok-url.ngrok-free.app/webhook/ingredient-check" 
                           value="">
                </div>
                <div style="margin-bottom: 10px;">
                    <label for="responseUrl" style="font-size: 12px;">Response URL:</label>
                    <input type="text" id="responseUrl" class="config-input" 
                           placeholder="https://your-ngrok-url.ngrok-free.app/webhook/response/" 
                           value="">
                </div>
                <div class="alert alert-warning" id="configAlert">
                    <strong>Setup Required:</strong> Configure your webhook URLs above, then uncheck "Use Mock Data" to connect to your API.
                </div>
            </div>

            <div class="input-section">
                <label for="ingredientInput">Enter ingredients (one per line):</label>
                <textarea 
                    id="ingredientInput" 
                    placeholder="Enter ingredients here, for example:&#10;Corn Starch&#10;Soy Lecithin&#10;Vanilla Extract&#10;Citric Acid&#10;Xanthan Gum"
                ></textarea>
            </div>

            <div class="button-group">
                <button class="check-btn" onclick="checkIngredients()">
                    <span id="checkBtnText">Check Ingredients</span>
                </button>
                <button class="clear-btn" onclick="clearResults()">Clear All</button>
            </div>

            <div class="stats-section" id="statsSection" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="certifiedCount">0</div>
                    <div class="stat-label">Certified</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="expiringCount">0</div>
                    <div class="stat-label">Expiring</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="issuesCount">0</div>
                    <div class="stat-label">Issues</div>
                </div>
            </div>

            <div class="results-section">
                <div class="results-table">
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th>Ingredient</th>
                                <th>Status</th>
                                <th>Expiry Date</th>
                                <th>Supplier</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                            <tr>
                                <td colspan="4" class="empty-state">
                                    Enter ingredients above and click "Check Ingredients" to see results
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Panel - AI Chatbot -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-icon chat-icon">ü§ñ</div>
                <h1>AI Halal Assistant</h1>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message message-ai">
                    <div class="message-content">
                        Hello! I'm your Halal AI Assistant. I can help you with questions about halal ingredients, certifications, and food regulations. How can I assist you today?
                    </div>
                </div>
            </div>

            <div class="chat-input-section">
                <input 
                    type="text" 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="Ask me about halal ingredients..."
                    onkeypress="handleChatKeyPress(event)"
                >
                <button class="send-btn" onclick="sendMessage()">
                    <span id="sendBtnText">Send</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // In-memory storage instead of localStorage
        let appState = {
            chatHistory: [],
            savedInput: '',
            config: {
                useMockData: true,
                webhookUrl: '',
                responseUrl: '',
                chatId: 'session_' + Date.now(),
                notificationThresholdDays: 30
            }
        };

        // Mock data for testing
        const MOCK_INGREDIENT_DATA = {
            'corn starch': {
                status: 'Certified',
                expiryDate: '2025-12-15',
                supplier: 'Halal Foods Sdn Bhd',
                certificateId: 'JAKIM-2024-001'
            },
            'soy lecithin': {
                status: 'Certified',
                expiryDate: '2025-07-10',
                supplier: 'Malaysian Soy Industries',
                certificateId: 'JAKIM-2024-002'
            },
            'vanilla extract': {
                status: 'Expired',
                expiryDate: '2025-05-01',
                supplier: 'Flavor Masters Sdn Bhd',
                certificateId: 'JAKIM-2023-015'
            },
            'citric acid': {
                status: 'Not Found',
                expiryDate: null,
                supplier: null,
                certificateId: null
            },
            'xanthan gum': {
                status: 'Certified',
                expiryDate: '2026-03-20',
                supplier: 'Biotech Ingredients Malaysia',
                certificateId: 'JAKIM-2024-008'
            },
            'lecithin': {
                status: 'Certified',
                expiryDate: '2025-09-30',
                supplier: 'Natural Ingredients Co.',
                certificateId: 'JAKIM-2024-012'
            },
            'gellan gum': {
                status: 'Certified',
                expiryDate: '2025-11-15',
                supplier: 'Bio Gums Malaysia',
                certificateId: 'JAKIM-2024-018'
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupConfigurationHandlers();
            initializeChat();
            autoSaveInput();
            updateConfigAlert();
        }

        function setupConfigurationHandlers() {
            const mockDataCheckbox = document.getElementById('useMockData');
            const apiUrlInput = document.getElementById('apiUrl');
            const responseUrlInput = document.getElementById('responseUrl');
            
            mockDataCheckbox.addEventListener('change', function() {
                appState.config.useMockData = this.checked;
                updateConfigAlert();
            });
            
            apiUrlInput.addEventListener('input', function() {
                appState.config.webhookUrl = this.value;
                updateConfigAlert();
            });

            responseUrlInput.addEventListener('input', function() {
                appState.config.responseUrl = this.value;
                updateConfigAlert();
            });
        }

        function updateConfigAlert() {
            const alert = document.getElementById('configAlert');
            const webhookUrl = document.getElementById('apiUrl').value;
            const responseUrl = document.getElementById('responseUrl').value;
            
            if (appState.config.useMockData) {
                alert.innerHTML = `
                    <strong>Mock Mode:</strong> Using sample data for demonstration.
                    <br><small>Configure webhook URLs and uncheck "Use Mock Data" to connect to your API.</small>
                `;
                alert.className = 'alert alert-warning';
            } else if (!webhookUrl || !responseUrl) {
                alert.innerHTML = `
                    <strong>Configuration Required:</strong> Please set both webhook and response URLs to use live API.
                `;
                alert.className = 'alert alert-error';
            } else {
                alert.innerHTML = `
                    <strong>Live Mode:</strong> Connected to your API endpoints.
                    <br><small>Make sure your webhook server includes proper CORS headers.</small>
                `;
                alert.className = 'alert alert-success';
            }
        }

        // Enhanced API call with better error handling
        async function makeApiCall(url, options = {}) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        // Add headers that might help with CORS
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type',
                        ...options.headers
                    },
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                clearTimeout(timeoutId);
                return response;
                
            } catch (error) {
                clearTimeout(timeoutId);
                
                if (error.name === 'AbortError') {
                    throw new Error('Request timeout - check your webhook URL');
                } else if (error.message.includes('CORS')) {
                    throw new Error('CORS error - configure Access-Control-Allow-Origin header on your webhook server');
                } else if (error.message.includes('fetch')) {
                    throw new Error('Network error - check if webhook URL is accessible');
                }
                
                throw error;
            }
        }

        // Ingredient checking functions
        async function checkIngredients() {
            const input = document.getElementById('ingredientInput').value.trim();
            if (!input) {
                showAlert('Please enter some ingredients to check.', 'warning');
                return;
            }

            const ingredients = input.split('\n').filter(line => line.trim());
            const button = document.querySelector('.check-btn');
            const buttonText = document.getElementById('checkBtnText');
            
            // Show loading state
            button.disabled = true;
            button.classList.add('loading');
            buttonText.textContent = '';

            const results = [];
            
            try {
                if (appState.config.useMockData) {
                    // Process mock data
                    for (const ingredient of ingredients) {
                        const result = await checkSingleIngredientMock(ingredient.trim());
                        results.push(result);
                    }
                } else {
                    // Validate configuration
                    if (!appState.config.webhookUrl || !appState.config.responseUrl) {
                        throw new Error('Please configure webhook and response URLs first');
                    }

                    // Process with real API
                    for (const ingredient of ingredients) {
                        try {
                            const result = await checkSingleIngredient(ingredient.trim());
                            results.push(result);
                        } catch (error) {
                            results.push({
                                ingredient: ingredient.trim(),
                                status: 'API Error',
                                expiryDate: null,
                                supplier: null,
                                error: error.message
                            });
                        }
                        
                        // Add delay between requests to avoid overwhelming the server
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }

                displayResults(results);
                updateStats(results);
                checkForExpiringCertificates(results);
                
            } catch (error) {
                console.error('Error checking ingredients:', error);
                showAlert(`Error: ${error.message}`, 'error');
            } finally {
                // Reset button state
                button.disabled = false;
                button.classList.remove('loading');
                buttonText.textContent = 'Check Ingredients';
            }
        }

        async function checkSingleIngredientMock(ingredient) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 300));
            
            const mockData = MOCK_INGREDIENT_DATA[ingredient.toLowerCase()];
            if (mockData) {
                return {
                    ingredient: ingredient,
                    ...mockData
                };
            } else {
                return {
                    ingredient: ingredient,
                    status: 'Not Found',
                    expiryDate: null,
                    supplier: null,
                    certificateId: null
                };
            }
        }

        async function checkSingleIngredient(ingredient) {
            const chatId = appState.config.chatId + '_' + ingredient.replace(/\s+/g, '_');
            
            try {
                // Send webhook request
                const response = await makeApiCall(appState.config.webhookUrl, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        ingredient: ingredient,
                        chatId: chatId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Webhook failed with status: ${response.status}`);
                }
                
                // Poll for response
                const result = await pollForResponse(chatId, ingredient);
                return result;
                
            } catch (error) {
                console.error(`Error checking ingredient ${ingredient}:`, error);
                throw error;
            }
        }

        async function pollForResponse(chatId, ingredient, maxAttempts = 6) {
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
                try {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    const responseUrl = `${appState.config.responseUrl}${chatId}`;
                    const response = await fetch(responseUrl);
                    
                    if (response.ok) {
                        const data = await response.json();
                        return {
                            ingredient: ingredient,
                            status: data.status || 'Not Found',
                            expiryDate: data.expiryDate || null,
                            supplier: data.supplier || null,
                            certificateId: data.certificateId || null
                        };
                    }
                } catch (error) {
                    console.log(`Polling attempt ${attempt + 1} failed for ${ingredient}`);
                }
            }
            
            // If polling fails, return timeout result
            return {
                ingredient: ingredient,
                status: 'Timeout',
                expiryDate: null,
                supplier: null,
                error: 'Response timeout - check if your webhook is processing correctly'
            };
        }

        function displayResults(results) {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            results.forEach(result => {
                const row = document.createElement('tr');
                
                const statusClass = getStatusClass(result.status);
                const formattedDate = result.expiryDate ? formatDate(result.expiryDate) : 'N/A';
                
                row.innerHTML = `
                    <td>${escapeHtml(result.ingredient)}</td>
                    <td><span class="status-cell ${statusClass}">${escapeHtml(result.status)}</span></td>
                    <td>${formattedDate}</td>
                    <td>${escapeHtml(result.supplier || 'N/A')}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            document.getElementById('statsSection').style.display = 'grid';
        }

        function getStatusClass(status) {
            switch (status.toLowerCase()) {
                case 'certified': return 'status-certified';
                case 'expiring': return 'status-expiring';
                case 'expired': return 'status-expired';
                case 'not found': return 'status-not-found';
                default: return 'status-not-found';
            }
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-MY', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (error) {
                return dateString;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateStats(results) {
            const stats = {
                total: results.length,
                certified: 0,
                expiring: 0,
                issues: 0
            };

            const today = new Date();
            const thresholdDate = new Date();
            thresholdDate.setDate(today.getDate() + appState.config.notificationThresholdDays);

            results.forEach(result => {
                switch (result.status.toLowerCase()) {
                    case 'certified':
                        if (result.expiryDate) {
                            const expiryDate = new Date(result.expiryDate);
                            if (expiryDate <= thresholdDate && expiryDate > today) {
                                stats.expiring++;
                            } else {
                                stats.certified++;
                            }
                        } else {
                            stats.certified++;
                        }
                        break;
                    case 'expired':
                    case 'not found':
                    case 'api error':
                    case 'timeout':
                    default:
                        stats.issues++;
                        break;
                }
            });

            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('certifiedCount').textContent = stats.certified;
            document.getElementById('expiringCount').textContent = stats.expiring;
            document.getElementById('issuesCount').textContent = stats.issues;
        }

        function checkForExpiringCertificates(results) {
            const today = new Date();
            const warningDate = new Date();
            warningDate.setDate(today.getDate() + appState.config.notificationThresholdDays);

            const expiring = results.filter(result => {
                if (result.expiryDate && result.status.toLowerCase() === 'certified') {
                    const expiryDate = new Date(result.expiryDate);
                    return expiryDate <= warningDate && expiryDate > today;
                }
                return false;
            });

            if (expiring.length > 0) {
                const ingredients = expiring.map(r => r.ingredient).join(', ');
                showAlert(`Warning: ${expiring.length} ingredient(s) have certificates expiring within ${appState.config.notificationThresholdDays} days: ${ingredients}`, 'warning');
            }
        }

        function clearResults() {
            document.getElementById('ingredientInput').value = '';
            document.getElementById('resultsBody').innerHTML = `
                <tr>
                    <td colspan="4" class="empty-state">
                        Enter ingredients above and click "Check Ingredients" to see results
                    </td>
                </tr>
            `;
            document.getElementById('statsSection').style.display = 'none';
            appState.savedInput = '';
        }

        function showAlert(message, type) {
            const existingAlert = document.querySelector('.alert-message');
            if (existingAlert) {
                existingAlert.remove();
            }

            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-message`;
            alert.textContent = message;
            
            const container = document.querySelector('.panel');
            container.insertBefore(alert, container.firstChild);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        function autoSaveInput() {
            const input = document.getElementById('ingredientInput');
            input.addEventListener('input', function() {
                appState.savedInput = this.value;
            });
            
            // Restore saved input
            input.value = appState.savedInput;
        }

        // Chat functionality
        function initializeChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            const sendBtn = document.querySelector('.send-btn');
            const sendBtnText = document.getElementById('sendBtnText');
            
            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Show loading state
            sendBtn.disabled = true;
            sendBtnText.textContent = 'Thinking...';
            
            // Add typing indicator
            addTypingIndicator();
            
            try {
                // Simulate AI response (replace with actual AI API call)
                const response = await getAIResponse(message);
                removeTypingIndicator();
                addMessage(response, 'ai');
                
            } catch (error) {
                removeTypingIndicator();
                addMessage('Sorry, I encountered an error. Please try again.', 'ai');
                console.error('Chat error:', error);
            } finally {
                sendBtn.disabled = false;
                sendBtnText.textContent = 'Send';
            }
        }

        function addMessage(content, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${sender}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            // Save to chat history
            appState.chatHistory.push({ content, sender, timestamp: Date.now() });
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message message-ai typing-indicator';
            typingDiv.id = 'typingIndicator';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = '<span class="dots">‚óè‚óè‚óè</span>';
            
            typingDiv.appendChild(contentDiv);
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Simple AI response simulation (replace with actual AI API)
        async function getAIResponse(message) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
            
            const lowerMessage = message.toLowerCase();
            
            // Simple keyword-based responses
            if (lowerMessage.includes('halal') && lowerMessage.includes('certificate')) {
                return "Halal certificates are issued by recognized Islamic bodies like JAKIM in Malaysia. They verify that products comply with Islamic dietary laws. Certificates typically have expiry dates and need renewal.";
            } else if (lowerMessage.includes('ingredient') && (lowerMessage.includes('check') || lowerMessage.includes('verify'))) {
                return "You can use the ingredient checker on the left to verify halal status. Simply enter ingredient names one per line and click 'Check Ingredients'. The system will show certification status, expiry dates, and suppliers.";
            } else if (lowerMessage.includes('gelatin') || lowerMessage.includes('gelatine')) {
                return "Gelatin can be halal or haram depending on its source. Halal gelatin is derived from halal animals (like cattle slaughtered according to Islamic law) or from fish. Pork-derived gelatin is haram.";
            } else if (lowerMessage.includes('alcohol') || lowerMessage.includes('ethanol')) {
                return "Alcohol in food products is a complex topic. Small amounts used in processing (like vanilla extract) may be permissible if the final product doesn't contain intoxicating amounts. However, many scholars prefer alcohol-free alternatives.";
            } else if (lowerMessage.includes('lecithin')) {
                return "Lecithin is generally halal when derived from plants (like soy lecithin). However, some lecithin may be derived from egg yolks, which is also halal. The source should be verified through proper certification.";
            } else if (lowerMessage.includes('emulsifier') || lowerMessage.includes('stabilizer')) {
                return "Emulsifiers and stabilizers can be halal or haram depending on their source. Plant-based ones like lecithin are typically halal. Always check for proper halal certification to be sure.";
            } else if (lowerMessage.includes('expires') || lowerMessage.includes('expiry') || lowerMessage.includes('renewal')) {
                return "Halal certificates have expiry dates to ensure ongoing compliance. Companies must renew their certificates before expiry. Our system flags ingredients with certificates expiring within 30 days.";
            } else if (lowerMessage.includes('jakim')) {
                return "JAKIM (Department of Islamic Development Malaysia) is Malaysia's main halal certification body. Their certificates are widely recognized internationally and indicate strict compliance with halal standards.";
            } else if (lowerMessage.includes('cross contamination') || lowerMessage.includes('cross-contamination')) {
                return "Cross-contamination with haram substances is a serious concern in halal food production. Certified facilities have strict protocols to prevent contact with pork, alcohol, and other non-halal substances.";
            } else {
                return "I'm here to help with halal ingredient questions! You can ask me about specific ingredients, certification processes, or use the ingredient checker to verify halal status. What would you like to know?";
            }
        }

        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            showAlert('An unexpected error occurred. Please refresh the page if problems persist.', 'error');
        });

        // Global unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            showAlert('A network error occurred. Please check your connection and try again.', 'error');
        });
    </script>
</body>
</html>
